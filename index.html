<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M77 AG Calculator with Data Export</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #a0845c;
            margin-bottom: 30px;
        }
        .input-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .input-group {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .input-group div {
            flex: 1;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #a0845c;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 4px;
        }
        .discount-banner {
            background: #a0845c;
            color: #000;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }
        table {
            width: 100%;
            background: #2a2a2a;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        th {
            background: #333;
            color: #a0845c;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        .service-header {
            background: #1a1a1a;
            color: #a0845c;
            font-weight: bold;
            text-transform: uppercase;
        }
        .summary {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #a0845c;
            margin-bottom: 30px;
        }
        .summary h2 {
            color: #a0845c;
            margin-bottom: 15px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .customer-section {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 8px;
            border: 2px solid #a0845c;
        }
        .customer-section h2 {
            color: #a0845c;
            margin-bottom: 20px;
            text-align: center;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            flex: 1;
        }
        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 30px;
        }
        .submit-btn, .export-btn, .view-btn {
            background: #a0845c;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
        }
        .submit-btn:hover, .export-btn:hover, .view-btn:hover {
            background: #b8956a;
        }
        .export-btn {
            background: #4CAF50;
        }
        .view-btn {
            background: #2196F3;
        }
        .stored-count {
            text-align: center;
            color: #a0845c;
            margin: 20px 0;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>M77 AG - Custom Farming Calculator</h1>
        
        <div class="stored-count" id="stored-count">
            Proposals Stored Locally: 0
        </div>
        
        <div class="input-section">
            <div class="input-group">
                <div>
                    <label>Total Acres</label>
                    <input type="number" id="acres" value="0" min="0">
                </div>
                <div>
                    <label>Primary Crop Type</label>
                    <select id="crop">
                        <option value="">Select Crop Type</option>
                        <option value="corn">Corn</option>
                        <option value="wheat">Wheat</option>
                        <option value="milo">Milo</option>
                    </select>
                </div>
            </div>
            
            <div id="discount-banner" class="discount-banner">
                Volume Discount: <span id="discount-rate">0%</span> OFF
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Service</th>
                    <th>Market Rate</th>
                    <th>Your Rate</th>
                    <th>Custom Rate</th>
                    <th>Total Cost</th>
                    <th>You Save</th>
                </tr>
            </thead>
            <tbody>
                <tr class="service-header">
                    <td colspan="7">TILLAGE OPERATIONS</td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="s1"></td>
                    <td>Discing</td>
                    <td>$18.75</td>
                    <td id="r1">$18.75</td>
                    <td><input type="number" id="c1" min="0" step="0.01"></td>
                    <td id="t1">$0.00</td>
                    <td id="sv1">$0.00</td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="s2"></td>
                    <td>Chisel Plow</td>
                    <td>$21.25</td>
                    <td id="r2">$21.25</td>
                    <td><input type="number" id="c2" min="0" step="0.01"></td>
                    <td id="t2">$0.00</td>
                    <td id="sv2">$0.00</td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="s3"></td>
                    <td>Field Finisher</td>
                    <td>$15.25</td>
                    <td id="r3">$15.25</td>
                    <td><input type="number" id="c3" min="0" step="0.01"></td>
                    <td id="t3">$0.00</td>
                    <td id="sv3">$0.00</td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="s4"></td>
                    <td>Strip Tillage</td>
                    <td>$13.50</td>
                    <td id="r4">$13.50</td>
                    <td><input type="number" id="c4" min="0" step="0.01"></td>
                    <td id="t4">$0.00</td>
                    <td id="sv4">$0.00</td>
                </tr>
                <tr class="service-header">
                    <td colspan="7">PLANTING OPERATIONS</td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="s5"></td>
                    <td>Corn Planting</td>
                    <td>$28.50</td>
                    <td id="r5">$28.50</td>
                    <td><input type="number" id="c5" min="0" step="0.01"></td>
                    <td id="t5">$0.00</td>
                    <td id="sv5">$0.00</td>
                </tr>
                <tr>
                    <td><input type="checkbox" id="s6"></td>
                    <td>Milo Planting</td>
                    <td>$26.75</td>
                    <td id="r6">$26.75</td>
                    <td><input type="number" id="c6" min="0" step="0.01"></td>
                    <td id="t6">$0.00</td>
                    <td id="sv6">$0.00</td>
                </tr>
            </tbody>
        </table>

        <div class="summary">
            <h2>CONTRACT SUMMARY</h2>
            <div class="summary-row">
                <span>Subtotal:</span>
                <span id="subtotal">$0.00</span>
            </div>
            <div class="summary-row">
                <span>Discount:</span>
                <span id="discount">$0.00</span>
            </div>
            <div class="summary-row">
                <span>Total:</span>
                <span id="total">$0.00</span>
            </div>
        </div>

        <div class="customer-section">
            <h2>Customer Information</h2>
            <p style="text-align: center; color: #888; font-size: 14px;">
                Testing Mode: Emails sending to kyle@togoag.com
            </p>
            <div class="form-row">
                <div class="form-group">
                    <label>Operation Name</label>
                    <input type="text" id="op-name">
                </div>
                <div class="form-group">
                    <label>Number of Fields</label>
                    <input type="number" id="fields" min="1">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" id="start">
                </div>
                <div class="form-group">
                    <label>Finish Date</label>
                    <input type="date" id="finish">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="phone">
                </div>
            </div>
            
            <div class="button-group">
                <button class="submit-btn" onclick="submitForm()">SAVE & EMAIL</button>
                <button class="export-btn" onclick="exportToExcel()">EXPORT ALL TO EXCEL</button>
                <button class="view-btn" onclick="viewProposals()">VIEW ALL PROPOSALS</button>
            </div>
        </div>
    </div>

<script>
// Market rates
var rates = [18.75, 21.25, 15.25, 13.50, 28.50, 26.75];
var names = ['Discing', 'Chisel Plow', 'Field Finisher', 'Strip Tillage', 'Corn Planting', 'Milo Planting'];

// Update stored count on load
function updateStoredCount() {
    var proposals = JSON.parse(localStorage.getItem('m77_proposals') || '[]');
    document.getElementById('stored-count').innerHTML = 'Proposals Stored Locally: ' + proposals.length;
}

function calc() {
    var a = document.getElementById('acres').value || 0;
    a = parseFloat(a);
    
    var d = 0;
    if (a >= 300) d = 0.14;
    else if (a >= 200) d = 0.10;
    else if (a >= 100) d = 0.07;
    
    var banner = document.getElementById('discount-banner');
    if (d > 0 && a > 0) {
        banner.style.display = 'block';
        document.getElementById('discount-rate').innerHTML = (d * 100) + '%';
    } else {
        banner.style.display = 'none';
    }
    
    var total = 0;
    var saved = 0;
    
    for (var i = 1; i <= 6; i++) {
        var rate = rates[i-1];
        var newRate = rate * (1 - d);
        
        document.getElementById('r' + i).innerHTML = '$' + newRate.toFixed(2);
        
        var cb = document.getElementById('s' + i);
        if (cb && cb.checked && a > 0) {
            var custom = document.getElementById('c' + i).value;
            custom = custom ? parseFloat(custom) : 0;
            
            var useRate = custom > 0 ? custom : newRate;
            var cost = useRate * a;
            var save = (rate - useRate) * a;
            
            document.getElementById('t' + i).innerHTML = '$' + cost.toFixed(2);
            document.getElementById('sv' + i).innerHTML = '$' + Math.max(0, save).toFixed(2);
            
            total += cost;
            saved += Math.max(0, save);
        } else {
            document.getElementById('t' + i).innerHTML = '$0.00';
            document.getElementById('sv' + i).innerHTML = '$0.00';
        }
    }
    
    document.getElementById('subtotal').innerHTML = '$' + total.toFixed(2);
    document.getElementById('discount').innerHTML = '-$' + saved.toFixed(2);
    document.getElementById('total').innerHTML = '$' + total.toFixed(2);
}

function submitForm() {
    var name = document.getElementById('op-name').value;
    var fields = document.getElementById('fields').value;
    var start = document.getElementById('start').value;
    var finish = document.getElementById('finish').value;
    var acres = document.getElementById('acres').value;
    var total = document.getElementById('total').innerHTML;
    var email = document.getElementById('email').value;
    var phone = document.getElementById('phone').value;
    
    if (!name || !fields || !start || !finish) {
        alert('Please fill all required fields');
        return;
    }
    
    // Get selected services
    var services = [];
    for (var i = 1; i <= 6; i++) {
        if (document.getElementById('s' + i).checked) {
            services.push({
                name: names[i-1],
                total: document.getElementById('t' + i).innerHTML,
                savings: document.getElementById('sv' + i).innerHTML
            });
        }
    }
    
    if (services.length == 0) {
        alert('Please select services');
        return;
    }
    
    // Create proposal object
    var proposal = {
        id: Date.now(),
        date: new Date().toLocaleDateString(),
        name: name,
        email: email,
        phone: phone,
        fields: fields,
        acres: acres,
        crop: document.getElementById('crop').value,
        start: start,
        finish: finish,
        services: services,
        subtotal: document.getElementById('subtotal').innerHTML,
        discount: document.getElementById('discount').innerHTML,
        total: total
    };
    
    // Save to localStorage
    var proposals = JSON.parse(localStorage.getItem('m77_proposals') || '[]');
    proposals.push(proposal);
    localStorage.setItem('m77_proposals', JSON.stringify(proposals));
    
    // Update count
    updateStoredCount();
    
    // Create email
    var emailBody = 'M77 AG CONTRACT PROPOSAL\n\n';
    emailBody += 'Proposal ID: ' + proposal.id + '\n';
    emailBody += 'Date: ' + proposal.date + '\n\n';
    emailBody += 'CUSTOMER INFORMATION\n';
    emailBody += 'Operation: ' + name + '\n';
    emailBody += 'Email: ' + email + '\n';
    emailBody += 'Phone: ' + phone + '\n';
    emailBody += 'Fields: ' + fields + '\n';
    emailBody += 'Acres: ' + acres + '\n';
    emailBody += 'Crop: ' + (proposal.crop || 'Not specified') + '\n';
    emailBody += 'Start: ' + start + '\n';
    emailBody += 'Finish: ' + finish + '\n\n';
    emailBody += 'SERVICES:\n';
    services.forEach(function(s) {
        emailBody += s.name + ': ' + s.total + ' (Save: ' + s.savings + ')\n';
    });
    emailBody += '\nTOTAL: ' + total;
    
    // EMAIL CONFIGURATION - Change this when ready for production
    // Testing email: kyle@togoag.com
    // Production email: m77@m77ag.com
    var subject = 'Proposal #' + proposal.id + ' - ' + name;
    var mailto = 'mailto:kyle@togoag.com?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(emailBody);
    
    // Save CSV backup
    downloadCSV(proposal);
    
    alert('Proposal #' + proposal.id + ' saved successfully!\n\nA CSV file has been downloaded.\nOpening email client...');
    
    window.location.href = mailto;
    
    // Clear form
    document.getElementById('op-name').value = '';
    document.getElementById('email').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('fields').value = '';
    document.getElementById('start').value = '';
    document.getElementById('finish').value = '';
}

function downloadCSV(proposal) {
    var csv = 'ID,Date,Customer,Email,Phone,Acres,Fields,Crop,Start,End,Services,Total\n';
    csv += proposal.id + ',';
    csv += proposal.date + ',';
    csv += proposal.name + ',';
    csv += proposal.email + ',';
    csv += proposal.phone + ',';
    csv += proposal.acres + ',';
    csv += proposal.fields + ',';
    csv += proposal.crop + ',';
    csv += proposal.start + ',';
    csv += proposal.finish + ',';
    csv += '"' + proposal.services.map(s => s.name + ':' + s.total).join(';') + '",';
    csv += proposal.total;
    
    var blob = new Blob([csv], {type: 'text/csv'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'Proposal_' + proposal.id + '_' + proposal.name.replace(/\s/g, '_') + '.csv';
    a.click();
}

function exportToExcel() {
    var proposals = JSON.parse(localStorage.getItem('m77_proposals') || '[]');
    
    if (proposals.length == 0) {
        alert('No proposals to export');
        return;
    }
    
    var csv = 'ID,Date,Customer,Email,Phone,Acres,Fields,Crop,Start,End,Total\n';
    
    proposals.forEach(function(p) {
        csv += p.id + ',';
        csv += p.date + ',';
        csv += p.name + ',';
        csv += (p.email || '') + ',';
        csv += (p.phone || '') + ',';
        csv += p.acres + ',';
        csv += p.fields + ',';
        csv += (p.crop || '') + ',';
        csv += p.start + ',';
        csv += p.finish + ',';
        csv += p.total + '\n';
    });
    
    var blob = new Blob([csv], {type: 'text/csv'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'M77_All_Proposals_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    
    alert('Exported ' + proposals.length + ' proposals to CSV file.\nOpen this file in Excel for analysis.');
}

function viewProposals() {
    var proposals = JSON.parse(localStorage.getItem('m77_proposals') || '[]');
    
    if (proposals.length == 0) {
        alert('No proposals stored yet');
        return;
    }
    
    var win = window.open('', 'Proposals', 'width=1000,height=600');
    var html = `
        <html>
        <head>
            <title>M77 AG - All Proposals</title>
            <style>
                body { font-family: Arial; padding: 20px; }
                h1 { color: #a0845c; }
                table { width: 100%; border-collapse: collapse; }
                th { background: #a0845c; color: white; padding: 10px; }
                td { border: 1px solid #ddd; padding: 8px; }
                tr:hover { background: #f5f5f5; }
                .print-btn { background: #a0845c; color: white; border: none; padding: 10px 20px; cursor: pointer; margin-bottom: 20px; }
            </style>
        </head>
        <body>
            <h1>M77 AG Proposals (${proposals.length} Total)</h1>
            <button class="print-btn" onclick="window.print()">Print Report</button>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Acres</th>
                        <th>Start</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>`;
    
    proposals.forEach(function(p) {
        html += `
            <tr>
                <td>${p.id}</td>
                <td>${p.date}</td>
                <td>${p.name}</td>
                <td>${p.email || ''}</td>
                <td>${p.phone || ''}</td>
                <td>${p.acres}</td>
                <td>${p.start}</td>
                <td>${p.total}</td>
            </tr>`;
    });
    
    html += `
                </tbody>
            </table>
            <h3>Total Revenue: ${proposals.reduce((sum, p) => sum + parseFloat(p.total.replace('$', '')), 0).toFixed(2)}</h3>
        </body>
        </html>`;
    
    win.document.write(html);
}

// Setup events
window.onload = function() {
    updateStoredCount();
    
    document.getElementById('acres').onchange = calc;
    document.getElementById('acres').oninput = calc;
    
    for (var i = 1; i <= 6; i++) {
        document.getElementById('s' + i).onchange = calc;
        document.getElementById('c' + i).onchange = calc;
        document.getElementById('c' + i).oninput = calc;
    }
    
    calc();
};
</script>

</body>
</html>
